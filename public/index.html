<script>
  // Toggle enable/disable of fitted sheet fields
  function toggleFitted() {
    const isFlatFitted = document.querySelector('input[name="sheetSetup"]:checked').value === 'flatFitted';
    document.querySelectorAll('[id^="fitted"]').forEach(el => {
      el.disabled = !isFlatFitted;
      if (!isFlatFitted) el.value = 0;
    });
  }

  // Auto-fill pillowcase counts based on bed counts
  function syncPillowcases() {
    const king = (+document.getElementById('bedKing').value || 0) + (+document.getElementById('bedCalKing').value || 0);
    const other = (+document.getElementById('bedQueen').value || 0) + (+document.getElementById('bedFull').value || 0) + (+document.getElementById('bedTwin').value || 0);
    document.getElementById('pillowKing').value = king * 2;
    document.getElementById('pillowStd').value = other * 2;
  }

  // Main calculation
  function calculateResults() {
    const par = +document.getElementById('parLevel').value || 1;
    const rooms = +document.getElementById('numRooms').value || 1;
    const occ = +document.getElementById('occupancy').value || 100;
    const results = { Bedding: {}, Terry: {} };
    const isFlatFitted = document.querySelector('input[name="sheetSetup"]:checked').value === 'flatFitted';
    const resultsDiv = document.getElementById('results');
    const table = document.getElementById('resultsTable');
    const summaryInfo = document.getElementById('summaryInfo');

    // --- Bedding ---
    ['King','CalKing','Queen','Full','Twin'].forEach(size => {
      const beds = +document.getElementById('bed' + size).value || 0;
      if (beds > 0) {
        if (isFlatFitted) {
          results.Bedding[`Flat Sheets (${size})`] = beds * par;
          results.Bedding[`Fitted Sheets (${size})`] = beds * par;
        } else {
          results.Bedding[`Flat Sheets (${size})`] = beds * 2 * par;
        }
      }
    });

    results.Bedding['King Pillowcases'] = (+document.getElementById('pillowKing').value || 0) * par;
    results.Bedding['Queen Pillowcases'] = (+document.getElementById('pillowQueen').value || 0) * par;
    results.Bedding['Standard Pillowcases'] = (+document.getElementById('pillowStd').value || 0) * par;

    // --- Terry ---
    const baths = +document.getElementById('numBathrooms').value || 1;
    results.Terry['Bath Towels'] = (+document.getElementById('towelBath').value || 0) * baths * par;
    results.Terry['Hand Towels'] = (+document.getElementById('towelHand').value || 0) * baths * par;
    results.Terry['Washcloths'] = (+document.getElementById('towelWash').value || 0) * baths * par;
    results.Terry['Bath Mats'] = (+document.getElementById('towelMat').value || 0) * baths * par;

    // --- Render Results ---
    table.innerHTML = '';
    Object.entries(results).forEach(([section, items]) => {
      const headerRow = document.createElement('tr');
      headerRow.innerHTML = `<th colspan='2'>${section}</th>`;
      table.appendChild(headerRow);
      Object.entries(items).forEach(([item, qty]) => {
        const row = document.createElement('tr');
        row.innerHTML = `<td>${item}</td><td>${qty} units</td>`;
        table.appendChild(row);
      });
    });

    const date = new Date().toLocaleDateString();
    summaryInfo.innerHTML = `<p><strong>Guest Rooms:</strong> ${rooms} | <strong>Occupancy:</strong> ${occ}% | <strong>PAR:</strong> ${par}</p><p><em>Generated on ${date}</em></p>`;
    resultsDiv.style.display = 'block';
  }

  // PDF export
  function exportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let y = 20;
    doc.setFontSize(16);
    doc.text('Liberty Linen - Estimated Linen Requirements', 20, y);
    y += 10;
    doc.setFontSize(11);
    document.querySelectorAll('#summaryInfo p').forEach(p => { doc.text(p.textContent, 20, y); y += 8; });
    y += 5;
    document.querySelectorAll('#resultsTable tr').forEach(tr => {
      const cells = tr.querySelectorAll('th, td');
      if (cells.length === 1) { doc.setFont(undefined, 'bold'); doc.text(cells[0].textContent, 20, y); doc.setFont(undefined, 'normal'); }
      else { doc.text(cells[0].textContent, 25, y); doc.text(cells[1].textContent, 120, y); }
      y += 8;
    });
    doc.setFontSize(10);
    doc.text('*These values are estimates based on your inputs.', 20, y + 10);
    doc.save('Liberty_Linen_PAR_Results.pdf');
  }

  // Email results
  function emailResults() {
    const summary = document.getElementById('summaryInfo').innerText;
    const rows = Array.from(document.querySelectorAll('#resultsTable tr')).map(r => r.innerText).join('%0D%0A');
    window.location.href = `mailto:?subject=Liberty Linen PAR Results&body=${encodeURIComponent(summary + '\n' + rows)}`;
  }

  // Initialize defaults on load
  window.onload = () => {
    toggleFitted();
    syncPillowcases();
    document.querySelectorAll('input[name="sheetSetup"]').forEach(r => r.addEventListener('change', toggleFitted));
  };
</script>
