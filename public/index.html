<!-- ──────────────────────────────── -->
<!-- START PART 1: <head> section -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Liberty Linen PAR Calculator v4</title>

  <!-- Fonts / Libraries -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Core Styles -->
  <style>
    :root{
      --french-blue:#3A6EA5;
      --slate-navy:#1E2A38;
      --card:#ffffff;
      --ink:#1E2A38;
      --muted:#667085;
      --soft:#f5f8ff;
    }
    *{box-sizing:border-box}
    body{
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:linear-gradient(90deg,var(--french-blue),var(--slate-navy));
      margin:0;padding:0;color:#333;
    }
    .container{
      max-width:1180px;margin:40px auto;background:var(--card);
      border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.12);
      padding:36px 32px;
    }
    .logo-header{display:flex;justify-content:center;align-items:center;gap:16px;margin-bottom:20px}
    .logo-header img{max-width:260px;height:auto}
    h1{margin:6px 0 26px;text-align:center;color:var(--slate-navy);font-size:2rem}
    .section{
      margin:28px 0 40px;background:var(--soft);border-left:6px solid var(--french-blue);
      border-radius:8px;padding:20px 20px;
    }
    .section h2{margin:0;color:var(--french-blue);font-size:1.25rem}
    .field-group{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:18px;margin-top:16px}
    .field{display:flex;flex-direction:column}
    .field label{font-weight:600;margin-bottom:6px;color:var(--ink)}
    .field input,.field select{
      padding:10px 12px;border:1px solid #d0d5dd;border-radius:8px;font-size:1rem;background:#fff
    }
    .field input[disabled]{background:#eef1f6}
    .radio-toggle{display:flex;gap:22px;margin-top:10px;font-weight:600}
    .radio-toggle input{margin-right:8px}
    .hint{color:var(--muted);font-size:.9rem;margin-top:6px}
    button{
      background:var(--slate-navy);color:#fff;border:none;border-radius:8px;
      padding:14px 18px;font-size:1.05rem;margin-top:18px;cursor:pointer
    }
    button:hover{background:var(--french-blue)}
    .results{margin-top:28px;background:#e9f1ff;padding:18px;border-radius:8px;display:none}
    .results h2{color:var(--slate-navy);margin:0 0 10px}
    table{width:100%;border-collapse:collapse}
    .results-table th,.results-table td{padding:10px;text-align:left}
    .results-table th{border-bottom:2px solid var(--slate-navy);color:var(--slate-navy)}
    .results-table td{border-bottom:1px solid #c9d4e8}
    .export-buttons{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:16px}
    .branding{text-align:center;margin-top:26px;color:#98a2b3;font-weight:500;font-size:.9rem}
    a{color:var(--french-blue);text-decoration:none}
    .pillows-title{font-weight:700;color:var(--ink);margin-top:6px}
    .pillows-grid{display:grid;grid-template-columns:1fr;gap:16px;margin-top:12px}
    .pillows-item{display:grid;grid-template-columns:220px 1fr 1fr;gap:12px;align-items:start}
    .checkbox-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:8px;background:#fff;border:1px solid #d0d5dd;border-radius:8px;padding:12px}
    .checkbox-grid label{font-weight:500}
    @media(max-width:900px){.pillows-item{grid-template-columns:1fr}}
    /* Top of Bed */
    .toggle-row{display:flex;align-items:center;gap:10px;margin-top:8px}
    .collapsed{display:none}
    .top-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:12px}
    @media(max-width:900px){.top-grid{grid-template-columns:1fr 1fr}}
    /* Pricing */
    .pricing{display:none;background:#fff;border:1px solid #d0d5dd;border-radius:10px;padding:16px;margin-top:18px}
    .pricing h3{margin:0 0 8px;color:var(--slate-navy)}
    .pricing-table th,.pricing-table td{padding:8px;border-bottom:1px solid #eef1f6}
    .pricing-table th{color:var(--slate-navy)}
    .right{text-align:right}
    .subtotal-row td{font-weight:700}
    .muted{color:#98a2b3;font-size:.9rem}
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0;}
    input[type="number"]{-moz-appearance:textfield;}
  </style>
</head>
<!-- END PART 1 -->
<!-- ──────────────────────────────── -->
<!-- ──────────────────────────────── -->
<!-- START PART 2: <body> section -->
<body>
  <div class="container">
    <div class="logo-header">
      <img src="https://raw.githubusercontent.com/campbell3cw/Hospitality-Par-Calculater/main/public/Liberty%20Logo.jpg" alt="Liberty Linen Logo">
    </div>
    <h1>Hospitality PAR Calculator</h1>

    <!-- General Info -->
    <div class="section">
      <h2>General Property Info</h2>
      <div class="field-group">
        <div class="field"><label for="numRooms">Guest Rooms</label><input type="number" id="numRooms" value="1" min="0"/></div>
        <div class="field"><label for="occupancy">Occupancy (%)</label><input type="number" id="occupancy" value="100" min="0" max="100"/></div>
        <div class="field"><label for="parLevel">PAR Level</label><input type="number" id="parLevel" value="3" min="1"/></div>
      </div>
    </div>

    <!-- Bedding -->
    <div class="section">
      <h2>Bedding Inventory</h2>
      <div class="radio-toggle">
        <label><input type="radio" name="sheetSetup" value="twoFlats" checked> Two Flat Sheets</label>
        <label><input type="radio" name="sheetSetup" value="flatFitted"> Flat + Fitted</label>
      </div>

      <!-- Bed counts -->
      <div class="field-group">
        <div class="field"><label>King Beds</label><input type="number" id="bedKing" value="0" min="0"/></div>
        <div class="field"><label>Cal King Beds</label><input type="number" id="bedCalKing" value="0" min="0"/></div>
        <div class="field"><label>Queen Beds</label><input type="number" id="bedQueen" value="0" min="0"/></div>
        <div class="field"><label>Full Beds</label><input type="number" id="bedFull" value="0" min="0"/></div>
        <div class="field"><label>Twin Beds</label><input type="number" id="bedTwin" value="0" min="0"/></div>
      </div>

      <div class="hint">If "Flat + Fitted" is selected, fitted counts mirror beds. Two-Flat greys them out.</div>
      <div class="field-group">
        <div class="field"><label>Fitted King</label><input type="number" id="fittedKing" value="0" min="0" /></div>
        <div class="field"><label>Fitted Cal King</label><input type="number" id="fittedCalKing" value="0" min="0" /></div>
        <div class="field"><label>Fitted Queen</label><input type="number" id="fittedQueen" value="0" min="0" /></div>
        <div class="field"><label>Fitted Full</label><input type="number" id="fittedFull" value="0" min="0" /></div>
        <div class="field"><label>Fitted Twin</label><input type="number" id="fittedTwin" value="0" min="0" /></div>
      </div>

      <!-- Pillowcases -->
      <div class="pillows-title">Pillowcases</div>
      <div class="pillows-grid">

        <!-- King Pillowcases -->
        <div class="pillows-item">
          <div class="field">
            <label>King Pillowcases (computed)</label>
            <input type="number" id="pillowKing" value="0" readonly />
          </div>
          <div class="field">
            <label>Used for Beds (multi-select)</label>
            <div class="checkbox-grid" id="mapKing">
              <label><input type="checkbox" value="King" checked> King</label>
              <label><input type="checkbox" value="CalKing"> Cal King</label>
              <label><input type="checkbox" value="Queen"> Queen</label>
              <label><input type="checkbox" value="Full"> Full</label>
              <label><input type="checkbox" value="Twin"> Twin</label>
              <label><input type="checkbox" value="All"> All</label>
            </div>
          </div>
          <div class="field">
            <label>Pillows per Bed</label>
            <select id="ppbKing">
              <option>1</option><option selected>2</option><option>3</option><option>4</option>
            </select>
          </div>
        </div>

        <!-- Queen Pillowcases -->
        <div class="pillows-item">
          <div class="field">
            <label>Queen Pillowcases (computed)</label>
            <input type="number" id="pillowQueen" value="0" readonly />
          </div>
          <div class="field">
            <label>Used for Beds (multi-select)</label>
            <div class="checkbox-grid" id="mapQueen">
              <label><input type="checkbox" value="King"> King</label>
              <label><input type="checkbox" value="CalKing"> Cal King</label>
              <label><input type="checkbox" value="Queen" checked> Queen</label>
              <label><input type="checkbox" value="Full"> Full</label>
              <label><input type="checkbox" value="Twin"> Twin</label>
              <label><input type="checkbox" value="All"> All</label>
            </div>
          </div>
          <div class="field">
            <label>Pillows per Bed</label>
            <select id="ppbQueen">
              <option>1</option><option selected>2</option><option>3</option><option>4</option>
            </select>
          </div>
        </div>

        <!-- Standard Pillowcases -->
        <div class="pillows-item">
          <div class="field">
            <label>Standard Pillowcases (computed)</label>
            <input type="number" id="pillowStd" value="0" readonly />
          </div>
          <div class="field">
            <label>Used for Beds (multi-select)</label>
            <div class="checkbox-grid" id="mapStd">
              <label><input type="checkbox" value="King"> King</label>
              <label><input type="checkbox" value="CalKing"> Cal King</label>
              <label><input type="checkbox" value="Queen"> Queen</label>
              <label><input type="checkbox" value="Full" checked> Full</label>
              <label><input type="checkbox" value="Twin" checked> Twin</label>
              <label><input type="checkbox" value="All"> All</label>
            </div>
          </div>
          <div class="field">
            <label>Pillows per Bed</label>
            <select id="ppbStd">
              <option>1</option><option selected>2</option><option>3</option><option>4</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- Terry -->
    <div class="section">
      <h2>Terry Inventory</h2>
      <div class="field-group">
        <div class="field"><label>Bathrooms per Room</label><input type="number" id="numBathrooms" value="1" min="0"/></div>
        <div class="field"><label>Bath Towels</label><input type="number" id="towelBath" value="0" min="0"/></div>
        <div class="field"><label>Hand Towels</label><input type="number" id="towelHand" value="0" min="0"/></div>
        <div class="field"><label>Washcloths</label><input type="number" id="towelWash" value="0" min="0"/></div>
        <div class="field"><label>Bath Mats</label><input type="number" id="towelMat" value="0" min="0"/></div>
      </div>
    </div>

    <!-- Top of Bed -->
    <div class="section">
      <h2>Top of the Bed (optional)</h2>
      <div class="toggle-row">
        <label><input type="checkbox" id="includeTop" /> Include Top-of-Bed products</label>
      </div>
      <div id="topBedPanel" class="collapsed">
        <div class="hint">Quantities auto-fill from bed counts. Edit if needed. Values are per size × PAR.</div>

        <div class="pillows-title" style="margin-top:16px">Top Sheet</div>
        <div class="top-grid">
          <div class="field"><label>King</label><input type="number" id="tsKing" value="0" min="0"/></div>
          <div class="field"><label>Queen</label><input type="number" id="tsQueen" value="0" min="0"/></div>
          <div class="field"><label>Full</label><input type="number" id="tsFull" value="0" min="0"/></div>
          <div class="field"><label>Twin</label><input type="number" id="tsTwin" value="0" min="0"/></div>
        </div>

        <div class="pillows-title" style="margin-top:10px">Coverlet</div>
        <div class="top-grid">
          <div class="field"><label>King</label><input type="number" id="cvKing" value="0" min="0"/></div>
          <div class="field"><label>Queen</label><input type="number" id="cvQueen" value="0" min="0"/></div>
          <div class="field"><label>Full</label><input type="number" id="cvFull" value="0" min="0"/></div>
          <div class="field"><label>Twin</label><input type="number" id="cvTwin" value="0" min="0"/></div>
        </div>

        <div class="pillows-title" style="margin-top:10px">Filled Blanket</div>
        <div class="top-grid">
          <div class="field"><label>King</label><input type="number" id="fbKing" value="0" min="0"/></div>
          <div class="field"><label>Queen</label><input type="number" id="fbQueen" value="0" min="0"/></div>
          <div class="field"><label>Full</label><input type="number" id="fbFull" value="0" min="0"/></div>
          <div class="field"><label>Twin</label><input type="number" id="fbTwin" value="0" min="0"/></div>
        </div>

        <div class="pillows-title" style="margin-top:10px">Duvet / Insert</div>
        <div class="top-grid">
          <div class="field"><label>King</label><input type="number" id="dvKing" value="0" min="0"/></div>
          <div class="field"><label>Queen</label><input type="number" id="dvQueen" value="0" min="0"/></div>
          <div class="field"><label>Full</label><input type="number" id="dvFull" value="0" min="0"/></div>
          <div class="field"><label>Twin</label><input type="number" id="dvTwin" value="0" min="0"/></div>
        </div>
      </div>
    </div>

    <!-- Calculate Button -->
    <button id="calcBtn" onclick="calculateResults()">Calculate Requirements</button>

    <!-- Results -->
    <div class="results" id="results">
      <h2>Estimated Linen Requirements</h2>
      <div id="summaryInfo"></div>
      <table class="results-table" id="resultsTable"></table>

      <!-- Pricing -->
      <div class="pricing" id="pricing">
        <h3>Pricing</h3>
        <table class="pricing-table" id="pricingTable">
          <thead>
            <tr>
              <th>Category</th>
              <th>Item</th>
              <th class="right">Qty (units)</th>
              <th class="right">Qty (dozens)</th>
              <th class="right">Price / Each</th>
              <th class="right">Price / Dozen</th>
              <th class="right">Subtotal (Dozens)</th>
            </tr>
          </thead>
          <tbody id="pricingBody"></tbody>
          <tbody id="pricingSubtotals"></tbody>
          <tfoot>
            <tr class="subtotal-row">
              <td colspan="6" class="right">Grand Total</td>
              <td class="right" id="grandTotal">$0.00</td>
            </tr>
            <tr>
              <td colspan="7" class="muted right">* Sales tax not included</td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="export-buttons">
        <button onclick="exportPDF()">Export to PDF</button>
        <button onclick="emailResults()">Email Results</button>
      </div>
    </div>

    <div class="branding">Powered by Liberty Linen · Orange Beach, AL · <a href="https://www.libertylinen.com">libertylinen.com</a></div>
  </div>
<!-- END PART 2 -->
<!-- ──────────────────────────────── -->
<!-- ──────────────────────────────── -->
<!-- START PART 3: <script> section -->
<script>
  // === Helpers ===
  function getBedsMap() {
    return {
      King: +document.getElementById('bedKing').value || 0,
      CalKing: +document.getElementById('bedCalKing').value || 0,
      Queen: +document.getElementById('bedQueen').value || 0,
      Full: +document.getElementById('bedFull').value || 0,
      Twin: +document.getElementById('bedTwin').value || 0,
    };
  }
  function totalBeds(map){ return Object.values(map).reduce((a,b)=>a+b,0); }
  function totalBedsSelected(containerId){
    const map = getBedsMap();
    const boxWrap = document.getElementById(containerId);
    const selected = Array.from(boxWrap.querySelectorAll('input[type=checkbox]:checked')).map(cb=>cb.value);
    if(selected.includes('All')) return totalBeds(map);
    return selected.reduce((sum,key)=> sum + (map[key]||0), 0);
  }
  function ceilDozens(units){ return Math.ceil((+units||0)/12); }
  function toUSD(n){ return (isNaN(n)?0:n).toLocaleString(undefined,{style:'currency',currency:'USD'}); }

  // === Toggle Fitted Sheets ===
  function toggleFitted(){
    const selected = document.querySelector('input[name="sheetSetup"]:checked');
    if(!selected) return;
    const twoFlats = selected.value === 'twoFlats';
    const mirror = !twoFlats;
    const pairs = [
      ['King','fittedKing','bedKing'],
      ['CalKing','fittedCalKing','bedCalKing'],
      ['Queen','fittedQueen','bedQueen'],
      ['Full','fittedFull','bedFull'],
      ['Twin','fittedTwin','bedTwin'],
    ];
    pairs.forEach(([size, fittedId, bedId])=>{
      const fittedEl = document.getElementById(fittedId);
      const bedEl = document.getElementById(bedId);
      fittedEl.disabled = twoFlats;
      fittedEl.value = mirror ? (+bedEl.value || 0) : 0;
    });
  }

  // === Pillowcase Computation (multi-map) ===
  function syncPillowcases(){
    const mapK = totalBedsSelected('mapKing');
    const mapQ = totalBedsSelected('mapQueen');
    const mapS = totalBedsSelected('mapStd');
    const ppbK = +document.getElementById('ppbKing').value;
    const ppbQ = +document.getElementById('ppbQueen').value;
    const ppbS = +document.getElementById('ppbStd').value;
    document.getElementById('pillowKing').value = mapK * ppbK;
    document.getElementById('pillowQueen').value = mapQ * ppbQ;
    document.getElementById('pillowStd').value = mapS * ppbS;
  }

  // === Top-of-Bed Autofill ===
  function autofillTopOfBed(){
    const map = getBedsMap();
    const pairs = [
      ['tsKing','King'],['tsQueen','Queen'],['tsFull','Full'],['tsTwin','Twin'],
      ['cvKing','King'],['cvQueen','Queen'],['cvFull','Full'],['cvTwin','Twin'],
      ['fbKing','King'],['fbQueen','Queen'],['fbFull','Full'],['fbTwin','Twin'],
      ['dvKing','King'],['dvQueen','Queen'],['dvFull','Full'],['dvTwin','Twin'],
    ];
    pairs.forEach(([id,size])=>{
      const el = document.getElementById(id);
      el.value = map[size] || 0;
    });
  }

  // === Compute Results ===
  function computeResults(){
    const par = +document.getElementById('parLevel').value || 1;
    const bedsMap = getBedsMap();
    const setupRadio = document.querySelector('input[name="sheetSetup"]:checked');
    const isFlatFitted = setupRadio && setupRadio.value === 'flatFitted';

    const results = { Bedding:{}, TopOfBed:{}, Terry:{} };

    // Sheets
    ['King','CalKing','Queen','Full','Twin'].forEach(size=>{
      const beds = bedsMap[size] || 0;
      if(beds>0){
        if(isFlatFitted){
          results.Bedding[`Flat Sheets (${size})`] = beds * par;
          results.Bedding[`Fitted Sheets (${size})`] = (+document.getElementById('fitted'+size).value || 0) * par;
        }else{
          results.Bedding[`Flat Sheets (${size})`] = beds * 2 * par;
        }
      }
    });

    // Pillowcases
    const k = (+document.getElementById('pillowKing').value || 0) * par;
    const q = (+document.getElementById('pillowQueen').value || 0) * par;
    const s = (+document.getElementById('pillowStd').value || 0) * par;
    if(k>0) results.Bedding['King Pillowcases'] = k;
    if(q>0) results.Bedding['Queen Pillowcases'] = q;
    if(s>0) results.Bedding['Standard Pillowcases'] = s;

    // Top of Bed
    if(document.getElementById('includeTop').checked){
      const entries = [
        ['Top Sheet (King)','tsKing'],['Top Sheet (Queen)','tsQueen'],
        ['Top Sheet (Full)','tsFull'],['Top Sheet (Twin)','tsTwin'],
        ['Coverlet (King)','cvKing'],['Coverlet (Queen)','cvQueen'],
        ['Coverlet (Full)','cvFull'],['Coverlet (Twin)','cvTwin'],
        ['Filled Blanket (King)','fbKing'],['Filled Blanket (Queen)','fbQueen'],
        ['Filled Blanket (Full)','fbFull'],['Filled Blanket (Twin)','fbTwin'],
        ['Duvet / Insert (King)','dvKing'],['Duvet / Insert (Queen)','dvQueen'],
        ['Duvet / Insert (Full)','dvFull'],['Duvet / Insert (Twin)','dvTwin'],
      ];
      entries.forEach(([label,id])=>{
        const perSize = +document.getElementById(id).value || 0;
        const qty = perSize * par;
        if(qty>0) results.TopOfBed[label] = qty;
      });
    }

    // Terry
    const baths = +document.getElementById('numBathrooms').value || 1;
    const tBath = (+document.getElementById('towelBath').value || 0) * baths * par;
    const tHand = (+document.getElementById('towelHand').value || 0) * baths * par;
    const tWash = (+document.getElementById('towelWash').value || 0) * baths * par;
    const tMat  = (+document.getElementById('towelMat').value  || 0) * baths * par;
    if(tBath>0) results.Terry['Bath Towels'] = tBath;
    if(tHand>0) results.Terry['Hand Towels'] = tHand;
    if(tWash>0) results.Terry['Washcloths'] = tWash;
    if(tMat>0)  results.Terry['Bath Mats'] = tMat;

    return results;
  }

  // === Render Results Table ===
  function renderResults(results){
    const table = document.getElementById('resultsTable');
    table.innerHTML='';
    Object.entries(results).forEach(([section, items])=>{
      const keys = Object.keys(items);
      if(keys.length===0) return;
      const headerRow = document.createElement('tr');
      headerRow.innerHTML = `<th colspan="2">${section}</th>`;
      table.appendChild(headerRow);
      keys.forEach(key=>{
        const qty = items[key];
        if(qty<=0) return;
        const row = document.createElement('tr');
        row.innerHTML = `<td>${key}</td><td>${qty} units</td>`;
        table.appendChild(row);
      });
    });
  }

  // === Pricing ===
  let priceCache = {}; 
  function buildPricing(results){
    const pricing = document.getElementById('pricing');
    const body = document.getElementById('pricingBody');
    const subs = document.getElementById('pricingSubtotals');
    body.innerHTML=''; subs.innerHTML='';

    const rows = [];
    Object.entries(results).forEach(([cat, items])=>{
      Object.entries(items).forEach(([label, qty])=>rows.push({cat,label,qty}));
    });
    if(rows.length===0){ pricing.style.display='none'; return; }
    pricing.style.display='block';

    rows.forEach((r,i)=>{
      const dozens = ceilDozens(r.qty);
      const cache = priceCache[r.label] || {each:'', dozen:''};
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.cat}</td>
        <td>${r.label}</td>
        <td class="right">${r.qty}</td>
        <td class="right">${dozens}</td>
        <td class="right"><input type="number" step="0.01" data-row="${i}" data-label="${r.label}" data-kind="each" class="price-input" style="width:110px;text-align:right" value="${cache.each}"></td>
        <td class="right"><input type="number" step="0.01" data-row="${i}" data-label="${r.label}" data-kind="dozen" class="price-input" style="width:110px;text-align:right" value="${cache.dozen}"></td>
        <td class="right" id="subtotal-${i}">$0.00</td>`;
      body.appendChild(tr);
    });

    ['Bedding','TopOfBed','Terry'].forEach(cat=>{
      const tr=document.createElement('tr');
      tr.className='subtotal-row';
      tr.innerHTML=`<td colspan="6" class="right">${cat} Subtotal</td><td class="right" id="sub-${cat}">$0.00</td>`;
      subs.appendChild(tr);
    });

    body.querySelectorAll('.price-input').forEach(inp=>inp.addEventListener('input', onPriceChange));
    recalcTotals();
  }

  function onPriceChange(e){
    const inp = e.target, label=inp.dataset.label, kind=inp.dataset.kind;
    const value=parseFloat(inp.value);
    if(!priceCache[label]) priceCache[label]={each:'',dozen:''};
    if(!isNaN(value)){
      priceCache[label][kind]=value.toFixed(2);
      const row=inp.closest('tr');
      if(kind==='each'){
        priceCache[label].dozen=(value*12).toFixed(2);
        row.querySelector('input[data-kind="dozen"]').value=priceCache[label].dozen;
      }else{
        priceCache[label].each=(value/12).toFixed(4);
        row.querySelector('input[data-kind="each"]').value=priceCache[label].each;
      }
    }else priceCache[label][kind]='';
    recalcTotals();
  }

  function recalcTotals(){
    const body=document.getElementById('pricingBody');
    const rows=Array.from(body.querySelectorAll('tr'));
    const catTotals={Bedding:0,TopOfBed:0,Terry:0};
    let grand=0;
    rows.forEach((tr,i)=>{
      const tds=tr.querySelectorAll('td');
      const cat=tds[0].textContent;
      const dozens=parseFloat(tds[3].textContent)||0;
      const doz=parseFloat(tr.querySelector('input[data-kind="dozen"]').value)||0;
      const subtotal=dozens*doz;
      document.getElementById(`subtotal-${i}`).textContent=toUSD(subtotal);
      catTotals[cat]=(catTotals[cat]||0)+subtotal;
      grand+=subtotal;
    });
    ['Bedding','TopOfBed','Terry'].forEach(cat=>{
      const el=document.getElementById(`sub-${cat}`); if(el) el.textContent=toUSD(catTotals[cat]||0);
    });
    document.getElementById('grandTotal').textContent=toUSD(grand);
  }

  // === Calculate and Display ===
  function calculateResults(){
    const par=+document.getElementById('parLevel').value||1;
    const rooms=+document.getElementById('numRooms').value||1;
    const occ=+document.getElementById('occupancy').value||100;
    syncPillowcases();
    const results=computeResults();
    renderResults(results);
    const date=new Date().toLocaleDateString();
    const summaryInfo=document.getElementById('summaryInfo');
    summaryInfo.innerHTML=`<p><strong>Guest Rooms:</strong> ${rooms} | <strong>Occupancy:</strong> ${occ}% | <strong>PAR:</strong> ${par}</p><p><em>Generated on ${date}</em></p>`;
    document.getElementById('results').style.display='block';
    buildPricing(results);
  }

  // === PDF & Email ===
  function exportPDF(){
    const { jsPDF }=window.jspdf;
    const doc=new jsPDF();
    const logo="https://raw.githubusercontent.com/campbell3cw/Hospitality-Par-Calculater/main/public/Liberty%20Logo.jpg";
    doc.addImage(logo,'JPEG',20,10,30,24);
    doc.setFontSize(16); doc.text('Liberty Linen - Estimated Linen Requirements',60,20);
    doc.setFontSize(11); doc.text('Including pricing summary',60,27);
    let y=38;
    const addLine=t=>{if(y>270){doc.addPage();y=20;} doc.text(t,20,y); y+=7;};
    document.querySelectorAll('#summaryInfo p').forEach(p=>{addLine(p.textContent);});
    document.querySelectorAll('#resultsTable tr').forEach(tr=>{
      const cells=tr.querySelectorAll('th,td');
      if(cells.length===1) addLine(cells[0].textContent);
      else addLine(`${cells[0].textContent} .... ${cells[1].textContent}`);
    });
    y+=6; doc.setFontSize(14); addLine('Pricing Summary (Dozens)'); doc.setFontSize(11);
    document.querySelectorAll('#pricingBody tr').forEach((tr,i)=>{
      const tds=tr.querySelectorAll('td');
      const item=`${tds[0].textContent} - ${tds[1].textContent}`;
      const dozens=tds[3].textContent;
      const each=tr.querySelector('input[data-kind="each"]').value||'0.00';
      const doz=tr.querySelector('input[data-kind="dozen"]').value||'0.00';
      const subtotal=document.getElementById(`subtotal-${i}`).textContent;
      addLine(`${item} | ${dozens} dz | $/ea: ${each} | $/dz: ${doz} | Subtotal: ${subtotal}`);
    });
    y+=6;
    addLine(`Bedding Subtotal: ${document.getElementById('sub-Bedding')?.textContent||'$0.00'}`);
    addLine(`Top of Bed Subtotal: ${document.getElementById('sub-TopOfBed')?.textContent||'$0.00'}`);
    addLine(`Terry Subtotal: ${document.getElementById('sub-Terry')?.textContent||'$0.00'}`);
    addLine(`Grand Total: ${document.getElementById('grandTotal')?.textContent||'$0.00'}`);
    addLine('* Sales tax not included');
    doc.save('Liberty_Linen_PAR_Results.pdf');
  }

  function emailResults(){
    exportPDF(); // auto-generate PDF first
    const subject="What we need to buy from Liberty Linen!";
    const summary=document.getElementById('summaryInfo').innerText;
    const rows=Array.from(document.querySelectorAll('#resultsTable tr')).map(r=>r.innerText).join('%0D%0A');
    const pricingRows=Array.from(document.querySelectorAll('#pricingBody tr')).map((tr,i)=>{
      const tds=tr.querySelectorAll('td');
      const each=tr.querySelector('input[data-kind="each"]').value||'0.00';
      const doz=tr.querySelector('input[data-kind="dozen"]').value||'0.00';
      const sub=document.getElementById('subtotal-'+i).textContent;
      return `${tds[0].textContent} - ${tds[1].textContent} | ${tds[3].textContent} dz | $/ea ${each} | $/dz ${doz} | Subtotal ${sub}`;
    }).join('%0D%0A');
    const totals=`Bedding: ${document.getElementById('sub-Bedding')?.textContent||'$0.00'}, Top of Bed: ${document.getElementById('sub-TopOfBed')?.textContent||'$0.00'}, Terry: ${document.getElementById('sub-Terry')?.textContent||'$0.00'}, Grand: ${document.getElementById('grandTotal')?.textContent||'$0.00'} (sales tax not included)`;
    const body=`${encodeURIComponent(summary)}%0D%0A%0D%0A${rows}%0D%0A%0D%0APricing:%0D%0A${pricingRows}%0D%0A%0D%0A${totals}%0D%0A%0D%0A(Attach the PDF named "Liberty_Linen_PAR_Results.pdf" that just downloaded.)`;
    window.location.href=`mailto:?subject=${encodeURIComponent(subject)}&body=${body}`;
  }

  // === Initialize ===
  document.addEventListener('DOMContentLoaded',()=>{
    const includeTop=document.getElementById('includeTop');
    const topPanel=document.getElementById('topBedPanel');
    includeTop.addEventListener('change',()=>{
      topPanel.classList.toggle('collapsed',!includeTop.checked);
      if(includeTop.checked) autofillTopOfBed();
    });
    toggleFitted();
    syncPillowcases();
    document.querySelectorAll('input[name="sheetSetup"]').forEach(r=>r.addEventListener('change',()=>{toggleFitted();syncPillowcases();}));
    ['bedKing','bedCalKing','bedQueen','bedFull','bedTwin'].forEach(id=>{
      document.getElementById(id).addEventListener('input',()=>{toggleFitted();syncPillowcases();if(includeTop.checked)autofillTopOfBed();});
    });
    ['mapKing','mapQueen','mapStd'].forEach(id=>document.getElementById(id).addEventListener('change',syncPillowcases));
    ['ppbKing','ppbQueen','ppbStd'].forEach(id=>document.getElementById(id).addEventListener('change',syncPillowcases));
  });
</script>
</body>
</html>
<!-- END PART 3 -->
<!-- ──────────────────────────────── -->